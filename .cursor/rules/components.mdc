---
description: Guidelines for authoring arcctl component configurations (architect.yml)
globs: "**/architect.yml,**/architect.yaml,**/components/**/*.yml,**/components/**/*.yaml"
alwaysApply: false
---

# Component Authoring Guidelines

Components are developer-focused application bundles in `architect.yml` files that describe what an application needs without specifying infrastructure details.

## File Structure

```yaml
# Component name comes from the OCI tag at build time
# README.md (if present) is bundled into the artifact for documentation

# Resources
databases: map<string, Database>
buckets: map<string, Bucket>
deployments: map<string, Deployment>
functions: map<string, Function>
services: map<string, Service>
routes: map<string, Route>
cronjobs: map<string, Cronjob>

# Configuration
variables: map<string, Variable>
dependencies: map<string, string>  # key: reference name, value: repo:tag
```

## Expression Syntax

Use `${{ ... }}` to reference values:

```yaml
environment:
  DATABASE_URL: ${{ databases.main.url }}
  REDIS_URL: ${{ databases.cache.url }}
  LOG_LEVEL: ${{ variables.log_level }}
  API_URL: ${{ services.api.url }}
```

## Available References

| Expression | Description |
|------------|-------------|
| `databases.<name>.url` | Database connection URL |
| `databases.<name>.host` | Database host |
| `databases.<name>.port` | Database port |
| `buckets.<name>.endpoint` | Bucket endpoint |
| `services.<name>.url` | Service URL |
| `variables.<name>` | Variable value |
| `dependencies.<name>.<output>` | Dependency outputs |

## Functions

Functions use a discriminated union: either `src` (source-based) or `container` (container-based).

### Source-Based Function (Recommended)

```yaml
functions:
  web:
    src:
      path: ./web
      framework: nextjs  # Optional - auto-detected
    environment:
      DATABASE_URL: ${{ databases.main.url }}
    memory: "1024Mi"
```

Most `src` fields are optional and auto-detected:
- `language`: Detected from package.json, go.mod, pyproject.toml
- `framework`: Detected from dependencies (next, fastapi, gin, etc.)
- `install`, `dev`, `build`, `start`: Detected from scripts/Makefile

### Container-Based Function

```yaml
functions:
  api:
    container:
      build:
        context: ./api
        dockerfile: Dockerfile
    port: 8080
```

Or with a pre-built image:

```yaml
functions:
  api:
    container:
      image: ghcr.io/myorg/api:v1.0.0
    port: 8080
```

## Common Patterns

### Database with Migrations

```yaml
databases:
  main:
    type: postgres:^15
    migrations:
      build:
        context: ./migrations
      command: ["npm", "run", "migrate"]
```

### Deployment with Health Check

```yaml
deployments:
  api:
    build:
      context: ./api
    environment:
      DATABASE_URL: ${{ databases.main.url }}
    cpu: "0.5"
    memory: "512Mi"
    replicas: 2
    liveness_probe:
      path: /health
      port: 8080
```

### Service with Route

```yaml
services:
  api:
    deployment: api
    port: 8080

routes:
  main:
    type: http
    rules:
      - matches:
          - path:
              type: PathPrefix
              value: /api
        backendRefs:
          - service: api
            port: 8080
```

### Route Pointing to Function

```yaml
functions:
  web:
    src:
      path: ./web
      framework: nextjs

routes:
  main:
    type: http
    function: web  # Simplified form - routes can point directly to functions
```

## Supported Database Types

- `postgres:^15` - PostgreSQL with semver version
- `mysql:^8` - MySQL
- `mariadb:^10` - MariaDB
- `mongodb:^6` - MongoDB
- `redis` - Redis (no version)
- `cockroachdb:^23` - CockroachDB distributed SQL
- `clickhouse:^24` - ClickHouse OLAP database
