---
title: "Ingress Hook"
description: "Set up external traffic routing for components"
---

# Ingress Hook

The ingress hook sets up external traffic routing when components declare routes. It handles DNS, TLS certificates, and load balancer configuration.

## Basic Usage

```hcl
ingress {
  module "ingress" {
    build = "./modules/ingress-rule"
    inputs = merge(node.inputs, {
      name          = "${node.component}--${node.name}"
      namespace     = module.namespace.id
      dns_zone      = variable.domain
      ingress_class = module.nginx.ingress_class_name
    })
  }

  module "dns" {
    build = "./modules/dns-record"
    inputs = {
      domain    = variable.domain
      subdomain = "${environment.name}-${node.component}"
      value     = module.ingress.load_balancer_ip
    }
  }

  outputs = {
    url  = module.ingress.url
    host = module.ingress.host
  }
}
```

## Inputs

The following inputs are available via `node.inputs`:

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Route name |
| `type` | string | Route type (http, grpc) |
| `internal` | boolean | VPC-only access |
| `rules` | array | Routing rules |
| `service` | string | Target service (shorthand) |
| `port` | number | Target port (shorthand) |

## Required Outputs

| Field | Type | Description |
|-------|------|-------------|
| `url` | string | Primary public URL |
| `hosts` | string[] | Array of assigned hostnames |

## Kubernetes Ingress Example

```hcl
ingress {
  module "ingress" {
    build = "./modules/k8s-ingress"
    inputs = {
      name          = "${node.component}--${node.name}"
      namespace     = module.namespace.id
      host          = "${environment.name}.${variable.domain}"
      service       = node.inputs.service
      port          = node.inputs.port
      rules         = node.inputs.rules
      ingress_class = "nginx"
    }
  }

  module "certificate" {
    build = "./modules/cert-manager-cert"
    inputs = {
      name      = "${node.component}--${node.name}"
      namespace = module.namespace.id
      host      = "${environment.name}.${variable.domain}"
    }
  }

  outputs = {
    url   = "https://${environment.name}.${variable.domain}"
    hosts = ["${environment.name}.${variable.domain}"]
  }
}
```

### Pulumi Module

```typescript
// modules/k8s-ingress/index.ts
import * as pulumi from "@pulumi/pulumi";
import * as k8s from "@pulumi/kubernetes";

const config = new pulumi.Config();
const name = config.require("name");
const namespace = config.require("namespace");
const host = config.require("host");
const service = config.require("service");
const port = config.requireNumber("port");

const ingress = new k8s.networking.v1.Ingress("ingress", {
  metadata: {
    name: name,
    namespace: namespace,
    annotations: {
      "kubernetes.io/ingress.class": "nginx",
      "cert-manager.io/cluster-issuer": "letsencrypt-prod",
    },
  },
  spec: {
    tls: [{
      hosts: [host],
      secretName: `${name}-tls`,
    }],
    rules: [{
      host: host,
      http: {
        paths: [{
          path: "/",
          pathType: "Prefix",
          backend: {
            service: {
              name: service,
              port: { number: port },
            },
          },
        }],
      },
    }],
  },
});

export const url = `https://${host}`;
export const host_out = host;
```

## AWS ALB Example

```hcl
ingress {
  module "alb" {
    build = "./modules/alb-ingress"
    inputs = {
      name        = "${environment.name}-${node.component}-${node.name}"
      vpc_id      = module.vpc.vpc_id
      subnets     = module.vpc.public_subnets
      target_port = node.inputs.port
      rules       = node.inputs.rules
    }
  }

  module "route53" {
    build = "./modules/route53-record"
    inputs = {
      zone_id = variable.route53_zone_id
      name    = "${environment.name}.${variable.domain}"
      type    = "A"
      alias = {
        name    = module.alb.dns_name
        zone_id = module.alb.zone_id
      }
    }
  }

  outputs = {
    url   = "https://${environment.name}.${variable.domain}"
    hosts = ["${environment.name}.${variable.domain}"]
  }
}
```

## Internal Routes

Handle internal (VPC-only) routes:

```hcl
ingress {
  when = node.inputs.internal == false

  module "public_ingress" {
    build = "./modules/public-ingress"
    inputs = {
      name = "${node.component}--${node.name}"
      host = "${environment.name}.${variable.domain}"
    }
  }

  outputs = {
    url   = "https://${environment.name}.${variable.domain}"
    hosts = ["${environment.name}.${variable.domain}"]
  }
}

ingress {
  when = node.inputs.internal == true

  module "internal_ingress" {
    build = "./modules/internal-ingress"
    inputs = {
      name = "${node.component}--${node.name}"
      host = "${environment.name}.internal.${variable.domain}"
    }
  }

  outputs = {
    url   = "https://${environment.name}.internal.${variable.domain}"
    hosts = ["${environment.name}.internal.${variable.domain}"]
  }
}
```

## Traffic Splitting

Handle weighted routing rules:

```hcl
ingress {
  module "ingress" {
    build = "./modules/k8s-ingress-canary"
    inputs = {
      name      = "${node.component}--${node.name}"
      namespace = module.namespace.id
      host      = "${environment.name}.${variable.domain}"
      rules     = node.inputs.rules  # Contains backendRefs with weights
    }
  }

  outputs = {
    url   = "https://${environment.name}.${variable.domain}"
    hosts = ["${environment.name}.${variable.domain}"]
  }
}
```
