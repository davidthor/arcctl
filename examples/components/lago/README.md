# Lago Component

This component deploys [Lago](https://www.getlago.com/), an open-source billing platform for usage-based pricing and subscriptions.

## Overview

Lago provides:
- Usage-based billing and metering
- Subscription management
- Invoice generation
- Payment integrations
- Real-time analytics

## Architecture

This component deploys the following services:

| Service | Image | Description |
|---------|-------|-------------|
| `front` | getlago/front | React-based web UI |
| `api` | getlago/api | Rails API backend |
| `api-worker` | getlago/api | Sidekiq worker for async jobs |
| `api-clock` | getlago/api | Clock process for scheduled tasks |
| `pdf` | gotenberg/gotenberg | PDF generation service |

Plus these databases:
- **PostgreSQL** - Primary data storage
- **Redis** - Job queue and caching

## Encryption Keys

This component uses arcctl's `encryptionKeys` feature to automatically generate and manage cryptographic keys:

| Key | Type | Purpose |
|-----|------|---------|
| `rsa-key` | RSA 2048-bit | Webhook signatures |
| `secret-key-base` | Symmetric 64 bytes | Rails session encryption |
| `encryption-primary` | Symmetric 32 bytes | Primary data encryption |
| `encryption-deterministic` | Symmetric 32 bytes | Deterministic encryption |
| `encryption-salt` | Symmetric 32 bytes | Key derivation |

These keys are automatically generated by the datacenter when deploying the component - no manual key generation required!

## SMTP (Email)

This component uses arcctl's `smtp` feature for email sending capabilities. The datacenter provisions SMTP credentials automatically, which may be fulfilled by various providers (AWS SES, SendGrid, Mailgun, etc.).

```yaml
smtp:
  email: {}
```

The "from" email address is controlled by the application via the `lago_from_email` variable.

## Example Environment Configuration

```yaml
# environment.yml
name: lago-production
datacenter: aws-ecs

components:
  lago:
    source: ./lago
    variables:
      lago_front_url: "https://billing.example.com"
      lago_api_url: "https://billing.example.com/api"
```

The datacenter automatically provisions:
- PostgreSQL database
- Redis for job queues and caching
- Encryption keys for security
- SMTP credentials for email (from the datacenter's configured email provider)

## Optional Features

### Google SSO

To enable Google Single Sign-On:

| Variable | Description |
|----------|-------------|
| `google_auth_client_id` | Google OAuth client ID |
| `google_auth_client_secret` | Google OAuth client secret |

### Feature Flags

| Variable | Default | Description |
|----------|---------|-------------|
| `lago_disable_signup` | `false` | Disable new user registration |
| `lago_sidekiq_web` | `false` | Enable Sidekiq job monitoring UI |
| `lago_webhook_attempts` | `3` | Retry attempts for failed webhooks |

## Storage

By default, Lago uses container-local storage. For production, you should configure external storage (S3 or GCS) by extending this component or using the Lago environment variables directly.

## Getting Started

After deployment:

1. Access the Lago UI at your configured `lago_front_url`
2. Sign up to create your organization
3. Find your API key in **Developer** > **API Keys**
4. Configure your billing plans and customers

## Documentation

- [Lago Documentation](https://docs.getlago.com/)
- [Self-Hosted Guide](https://www.getlago.com/docs/guide/lago-self-hosted/docker)
- [API Reference](https://doc.getlago.com/api-reference/intro)
